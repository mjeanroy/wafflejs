!function(t,e,n){!function(t){"function"==typeof define&&define.amd?define(["underscore","backbone"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone")):t(_,Backbone)}(function(i,r){"use strict";var s=r.$,o=function(t){return i.escape(t)},a=function(){var t=function(t){return function(e){if(!JSON||!JSON[t])throw Error("JSON."+t+" is not available in your browser");return JSON[t](e)}};return{toJson:t("stringify"),fromJson:t("parse")}}(),u=function(){var t="key_",e=function(e){return t+e},n=function(){this.$o={}};return n.prototype={clear:function(){this.$o={}},put:function(t,n){return this.$o[e(t)]=n,this},get:function(t){return this.$o[e(t)]},remove:function(t){return delete this.$o[e(t)],this},contains:function(t){return i.has(this.$o,e(t))}},n}(),h=function(){var t=new u,n={input:"input"};return{hasEvent:function(i){if("input"===i&&e.documentMode<=11)return!1;if(!t.contains(i)){var r=e.createElement(n[i]||"div"),s="on"+i in r;t.put(i,!!s),r=null}return t.get(i)}}}(),c=function(){var t=function(t,e){this.value=t,this.next=e||null},e=function(){this.root=null};return e.prototype={push:function(e){this.root=new t(e,this.root)},peek:function(){return this.root?this.root.value:n},pop:function(){var t;return this.root&&(t=this.root.value,this.root=this.root.next),t},isEmpty:function(){return!this.root}},e}(),l=function(){var t=new u,e=function(t){throw Error("Malformed expression: "+t||"unexpected end of input")},r=function(t,e){return e+t},s=function(t){return function(n,i,r,s){s.pop()!==t&&e()}},o="",a=".",h="[",l="(",d="]",f=")",v='"',p="'",g=" ",b={};b[a]=function(t,e,n){return n.push(e),o},b[h]=function(t,e,n,i){return i.push(t),b[a].apply(this,arguments)},b[l]=function(t,e,n,i){i.push(t)},b[v]=function(t,n,i,r){switch(r.peek()){case t:r.pop();break;case h:r.push(t);break;default:e()}},b[g]=function(t,e,n,i){var r=i.peek();return r!==l&&r!==h?e+t:void 0},b[p]=b[v],b[d]=s(h),b[f]=s(l);var $=function(t){for(var n=[],s=new c,o="",a=0,u=t.length;u>a;++a){var h=t.charAt(a),l=b[h]||r,d=l(h,o,n,s);i.isString(d)&&(o=d)}return s.isEmpty()&&o||e(),n.push(o),n},m=function(t){return null==t?{}:t},y=function(t,e){for(var r=t.length,s=e,o=0;r>o;++o){if(null==s||!i.isObject(s))return n;s=i.result(s,t[o])}return s},x=function(t,e,n){for(var r=t.length-1,s=e,o=s,a=0;r>a;++a)o=i.result(s,t[a]),o=s[t[a]]=m(o);return o[i.last(t)]=n,n};return function(e){if(!t.contains(e)){var n=$(e),i=function(t){return y(n,t)};i.assign=function(t,e){return x(n,t,e)},t.put(e,i)}return t.get(e)}}(),d="waffle-",f=d+"grid",v=d+"sortable",p=v+"-asc",g=v+"-desc",b=d+"draggable",$=b+"-drag",m=b+"-over",y=d+"fixedheader",x=d+"selectable",C=d+"selected",w=d+"checkbox",k="data-waffle-",E=k+"cid",N=k+"id",S=k+"sortable",A=k+"order",D=k+"idx",F="+",T="-",z="tbody",O="thead",R="tfoot",B="table",W={msie:function(){return e.documentMode},endWith:function(t,e){return!!t&&t.slice(t.length-e.length)===e},isPx:function(t){return W.endWith(t,"px")},isPercentage:function(t){return W.endWith(t,"%")},fromPercentage:function(t){return i.isString(t)?Number(t.replace("%","")):t},toPx:function(t){return i.isNumber(t)?t+"px":t},fromPx:function(t){return i.isString(t)?Number(t.replace("px","")):t},capitalize:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},resultWith:function(t,e,n){return i.isFunction(t)?t.apply(e,n):t},split:function(t,e){for(var n=e||20,i=[],r=[],s=0,o=t.length;o>s;++s)r.push(t[s]),r.length===n&&(i.push(r),r=[]);return r.length>0&&i.push(r),i},parse:function(t){try{return a.fromJson(t)}catch(e){if("false"===t)return!1;if("true"===t)return!0;var n=Number(t);return i.isNaN(n)?t:n}},destroy:function(t){for(var e in t)i.has(t,e)&&(t[e]=null)},toSpinalCase:function(t){for(var e="",n=0,i=t.length;i>n;++n){var r=t.charAt(n);e+=r.toLowerCase()===r?r:"-"+r.toLowerCase()}return e},asyncTask:function(t,e,n,i){var r=0,s=function(){if(t.length>0){var o=t.shift();n(o,r),r+=o.length,t.length>0?setTimeout(s,e):(i(),s=null)}};setTimeout(s)}},I=function(){var t=function(){var t=e.createElement("div");t.style.width="100px",t.style.height="100px",t.style.overflow="scroll",t.style.position="absolute",t.style.top="-9999px",e.body.appendChild(t);var n=t.offsetWidth-t.clientWidth;return e.body.removeChild(t),n},n=function(){return"body"},r=function(t,e){var n=e.type;n&&(t.type=n),i.forEach(i.keys(e),function(n){var r=e[n];switch(n){case"className":case"checked":case"indeterminate":case"value":t[n]=r;break;case"style":i.extend(t.style,r);break;default:t.setAttribute(n,r)}})},s=function(t,e){i.isString(e)?t.innerHTML=e:i.isArray(e)?i.forEach(e,function(e){t.appendChild(e)}):t.appendChild(e)},o={create:function(t,n,i){var o=e.createElement(t);return n&&r(o,n),i&&s(o,i),o},byId:function(t){var n=e.getElementById(t);return n?[n]:[]},byTagName:function(t,n){return(n||e).getElementsByTagName(t)},createFragment:function(){return e.createDocumentFragment()},findParent:function(t,e){for(;t&&t.tagName!==e;)t=t.parentNode;return t},scrollbarWidth:i.memoize(t,n)};return i.forEach(["tr","td","th",z,O,R,"input","select","option","span"],function(t){o[t]=function(e,n){return this.create.call(this,t,e,n)}}),i.forEach(["text","checkbox","number","email","url","date","time","datetime"],function(t){o["input"+W.capitalize(t)]=function(e,n){var r=i.extend({type:t},e||{});return this.input.call(this,r,n)}}),o}(),P=function(){var t=function(t,e,n){return t.replaceChild(n,e)},e=function(t,e){t.nodeValue!==e.nodeValue&&(t.nodeValue=e.nodeValue)},n=function(t,e){for(;t.firstChild;)t.removeChild(t.firstChild);for(;e.firstChild;)t.appendChild(e.firstChild)},r=function(t,e){s.mergeAttributes(t,e);var i=t.childNodes,r=e.childNodes;if(i.length!==r.length)n(t,e);else for(var o=0,a=i.length;a>o;++o)s.mergeNodes(t,i[o],r[o])},s={mergeNodes:function(n,i,s){var o=i.nodeType,a=s.nodeType,u=i.tagName,h=s.tagName,c=i;return o!==a||u!==h?(t(n,i,s),c=s):3===o?e(i,s):r(i,s),c},mergeAttributes:function(t,e){var n=i.indexBy(t.attributes,"name"),r=i.indexBy(e.attributes,"name");i.forEach(i.keys(r),function(e){var i=n[e]||null,s=i?i.value:null,o=r[e].value;s!==o&&t.setAttribute(e,o),i&&delete n[e]}),i.forEach(i.keys(n),function(e){t.removeAttribute(e)})}};return s}(),j=function(){var t=i.noop,e=function(t,e,n){this.type=t,this.bubbles=!1,this.cancelable=!1,this.details=n,this.timeStamp=i.now(),this.target=e,this.currentTarget=e,this.srcElement=e};return e.prototype={preventDefault:t,stopPropagation:t,stopImmediatePropagation:t},e}(),L=function(){var t=function(t){return t.toLowerCase()},e=function(){this.$events={}};return e.prototype={addEventListener:function(e,n){var i=t(e),r=this.$events,s=r[i]=r[i]||[];s.push(n)},removeEventListener:function(e,n){var r=t(e),s=this.$events[r];s&&s.length&&(this.$events[r]=i.reject(s,function(t){return t===n}))},dispatchEvent:function(e,n,r){n=t(n);var s=this.$events[n];if(s&&s.length)for(var o=new j(n,e,i.isFunction(r)?r.call(e):r),a=0,u=s.length;u>a;++a)try{s[a].call(e,o)}catch(h){}},clear:function(){this.$events={}}},e}(),U=function(){var t=function(t){return t&&t.length>0},e=function(){var e=this.$$changes,n=this.$$observers;if(t(e)&&t(n)){var r=e.splice(0,e.length);i.forEach(n,function(t){t.callback.call(t.ctx,r)})}this.$asyncTask=null},n={observe:function(t,e){return this.$$observers=this.$$observers||[],this.$$observers.push({ctx:e||null,callback:t}),this},unobserve:function(e,n){if(t(this.$$observers))if(0===arguments.length)this.$$observers=[];else{var r=n||null;this.$$observers=i.reject(this.$$observers,function(t){return t.ctx===r&&e===t.callback})}return this},notify:function(t){return i.isArray(t)||(t=[t]),this.$$changes=this.$$changes||[],this.$$changes.push.apply(this.$$changes,t),this.$asyncTask&&clearTimeout(this.$asyncTask),this.$asyncTask=setTimeout(i.bind(e,this)),this},pendingChanges:function(){return this.$$changes||[]},clearChanges:function(){return this.$$changes&&(clearTimeout(this.$asyncTask),this.$$changes.splice(0,this.$$changes.length),this.$asyncTask=null),this}};return n}(),M=function(){var t=function(t,e,n,i,r){return{type:t,removed:e,index:i,addedCount:n.length,object:r,added:n}};return{createSplice:function(e,n,i,r){return t("splice",e,n,i,r)},createUpdate:function(e,n){return t("update",[],[],e,n)}}}(),H=function(){var t=function(t){return(null==t?"":t).toString()},e={$identity:i.identity,$empty:function(){return""},$lowercase:function(e){return t(e).toLowerCase()},$uppercase:function(e){return t(e).toUpperCase()},$capitalize:function(e){return W.capitalize(t(e))},$get:function(t){return e[t]}};return e}(),V=function(){var t=function(t){return null==t?"":String(t.toString())},e=function(t){return null==t?0:Number(t)||0},n=function(t){return"false"===t?0:Boolean(t)?1:0},r=function(t){var n=i.isDate(t)?t:new Date(e(t));return n.getTime()},s=function(t){return function(e,n){return t(e)-t(n)}},o={$string:function(e,n){return t(e).localeCompare(t(n))},$number:s(e),$boolean:s(n),$date:s(r),$auto:function(t,e){if(t===e||null==t&&null==e)return 0;var n=i.find(["Number","Boolean","Date","String"],function(n){var r=i["is"+n];return r(t)||r(e)});return n?o["$"+n.toLowerCase()](t,e):e>t?-1:1},$get:function(t){return o[t]}};return o}(),q=function(){var t=function(t){return null==t?"":t.toString()},e=function(e,n,i){var r=t(e),s=t(n);return i(r,s)},n=function(t,e){return t.toLowerCase().indexOf(e.toLowerCase())>=0},r=function(t,i){return e(t,i,n)},s=function(t){var e=function(n){return i.some(i.keys(n),function(s){var o=n[s];return i.isObject(o)?e(o):r(n[s],t)})};return e},o=function(t){var e=i.map(i.keys(t),function(e){return function(n){return r(l(e)(n),t[e])}});return function(t){return i.every(e,function(e){return e(t)})}};return{$create:function(t){if(i.isFunction(t))return t;var e=i.isObject(t)?o:s,n=e(t);return n.$predicate=t,n}}}(),J=function(){var t=Array.prototype,e=function(){try{var e={};return e[0]=1,!!t.toString.call(e)}catch(n){return!1}}(),r=function(n){return function(){var r=e?this:i.toArray(this);return t[n].apply(r,arguments)}},s=function(t,e,n){return r(t).apply(e,n)},o=function(t,e){var n=e||{};this.$$map=new u,this.$$model=n.model||Object,this.$$key=n.key||"id",i.isFunction(this.$$key)||(this.$$key=l(this.$$key)),this.length=0,t&&t.length&&this.push.apply(this,t)},h=function(t){return parseInt(Number(t)||0,10)},c=M.createSplice,d=M.createUpdate,f=function(t,e){delete t[e]},v=function(t,e){t.$$map.remove(e)},p=function(t,e){var n=t.$$key(e),i=t.$$map.get(n),r=i?i.idx:null;null!=r&&(f(t,r),v(t,n))},g=function(t){throw Error(t)},b=function(t,e){i.isObject(e)||g("Waffle collections are not array, only object are allowed");var n;n=e instanceof t.$$model?e:new t.$$model(e);var r=t.$$key(n);return null==r&&g("Collection elements must have an id, you probably missed to specify the id key on initialization ?"),n},$=function(t){return b(this,t)},m=function(t,e,n,i){if(t[n]=e,null!=e){var r=arguments.length,s=3===r?t.$$key(e):i,o=t.$$map.get(s)||{};o.idx=n,t.$$map.put(s,o)}return e},y=function(t,e,n){var i=t.at(n),r=t.at(e);m(t,r,n),m(t,i,e)},x=function(t,e,n){for(var i=Math.abs(n),r=t.length-1;r>=e;--r)y(t,r,r+i);t.length+=i},C=function(t,e,n){for(var i=Math.abs(n),r=t.length,s=r-i,o=e+i,a=[],u=o;r>u;++u)y(t,u,u-i);for(var h=s;r>h;++h){var c=t.at(h);a.unshift(c),p(t,c)}return t.length=s,a},w=function(t,e){for(var n,r=t.$$sortFn,s=t.length,o=e.length,a=s+o,u=[],h=s-1,l=o-1,d=a-1;d>=0;--d)if(0>h||r(t[h],e[l])<0){var f=m(t,e[l--],d);if(n=i.first(u),n&&n.index===d+1?(n.index=d,n.addedCount++,n.added.unshift(f)):(n=c([],[f],d,t),u.unshift(n)),0>l)break}else m(t,t[h--],d);return t.length=a,u},k=function(t,e,n){var i=t.length,r=t.$$sortFn,s=n>0?t[n-1]:null;if(null!=s&&r(s,e)>0)return!1;var o=i>n?t[n+1]:null;return null!=o&&r(e,o)>0?!1:!0};o.prototype={options:function(){return{model:this.$$model,key:this.$$key}},at:function(t){return this[t]},byKey:function(t){var e=this.indexOf(t);return e>=0?this.at(e):n},ctx:function(t){var e=i.isObject(t)?this.$$key(t):t;return this.$$map.contains(e)?this.$$map.get(e):null},indexOf:function(t){var e=this.ctx(t);return e?e.idx:-1},contains:function(t){return this.indexOf(t)>=0},findIndex:function(t,e){for(var n=0,i=this.length;i>n;++n)if(t.call(e,this.at(n),n,this))return n;return-1},replace:function(t){var e=b(this,t),n=this.indexOf(e);0>n&&g("Data to replace is not in collection !");var i=this.length,r=this.$$sortFn;return r&&i>1&&!k(this,e,n)?(this.remove(e),this.push(e)):(this[n]=e,this.notifyUpdate(n)),this},add:function(t,e){var n=null==e?this.length:e,i=[n,0].concat(t);return this.splice.apply(this,i),this.length},remove:function(t,e){if(i.isNumber(t))return this.splice.call(this,t,e||this.length);if(i.isArray(t)){var n=this.$$key,r=i.indexBy(t,function(t){return n(t)});return this.remove(function(t){return!!r[n(t)]})}if(i.isObject(t)&&!i.isFunction(t)){var s=b(this,t),o=this.indexOf(s);return o>=0?this.remove(o,1):[]}for(var a=t,u=e,h=0,l=null,d=[],p=[],g=0,$=this.length;$>g;++g){var y=this.at(g),x=this.$$key(y);a.call(u,y,g)?(f(this,g),v(this,x),l===g-1?i.last(d).removed.push(y):d.push(c([y],[],g,this)),p.push(y),l=g):(h!==g&&(f(this,g),v(this,x),m(this,y,h,x)),h++)}return this.length-=p.length,d.length>0&&this.notify(d),p},notifyUpdate:function(t){return this.notify([d(t,this)])},push:function(){return this.add.call(this,i.toArray(arguments))},unshift:function(){return this.add.call(this,i.toArray(arguments),0)},pop:function(){return this.remove(this.length-1,1)[0]},shift:function(){return this.remove(0,1)[0]},toggle:function(t){var e=this.indexOf(t);return e>=0?this.remove(e,1):this.push(t)},clear:function(){if(this.length>0){for(var t=[],e=0,n=this.length;n>e;++e)t[e]=this.at(e),f(this,e);this.$$map.clear(),this.length=0,this.notify(c(t,[],0,this))}return this},reset:function(t){var e=this.length,n=t.length,r=i.map(t,$,this),s=this.$$sortFn;s&&r.sort(s),this.$$map.clear();for(var o=[],a=0;n>a;++a)e>a&&o.push(this.at(a)),m(this,r[a],a);for(;e>a;++a)o.push(this.at(a)),f(this,a);return this.length=n,this.notify([c(o,r,0,this)]),this},isEmpty:function(){return 0===this.length},concat:function(){var e=t.concat.apply(this.toArray(),arguments);return new o(e,this.options())},slice:function(){var t=s("slice",this,arguments);return new o(t,this.options())},splice:function(t,e){var n=this.$$sortFn,r=this.length,s=i.rest(arguments,2),o=i.map(s,$,this),a=h(t);a=a>=0?Math.min(r,a):Math.max(r+a,0);var u=Math.min(Math.max(h(e)||0,0),r-a),l=[];if(u>0){for(var d=0;u>d;++d)l.push(this[d+a]);C(this,a,u)}var f,v=i.groupBy(o,this.contains,this),p=v[!0]||[],g=v[!1]||[],b=g.length,y=p.length;if(b>0)if(n)g.sort(n),f=w(this,g);else{x(this,a,b);for(var k=0;b>k;++k)m(this,g[k],a+k);f=[c(l,g,a,this)]}else f=[];if(l.length>0){var E=i.find(f,function(t){return t.index===a});E?E.removed=l:f.unshift(c(l,[],a,this))}if(f.length>0&&this.notify(f),y>0){n&&p.sort(n);for(var N=0;y>N;++N)this.replace(p[N])}return l},reverse:function(){if(this.$$sortFn)return this;for(var t=this.length,e=Math.floor(t/2),n=[],i=[],r=0,s=t-1;e>r;++r,--s)y(this,r,s),n.push(d(r,this)),i.unshift(d(s,this));var o=n.concat(i);return o.length&&this.notify(o),this},split:function(t){return W.split(this,t)},toJSON:function(){return a.toJson(this.toArray())},sort:function(t){return this.$$sortFn=t,this.reset(this.toArray()).clearChanges()},pluck:function(t){var e=l(t);return this.map(function(t){return e(t)})}},o.prototype.lastIndexOf=o.prototype.indexOf,i.extend(o.prototype,U);var E=["size","first","last","initial","rest","partition","forEach","map","every","some","reduce","reduceRight","filter","reject","find","toArray"];return i.forEach(E,function(t){i[t]&&(o.prototype[t]=function(){var e=[this].concat(i.toArray(arguments));return i[t].apply(i,e)})}),i.forEach(["countBy","groupBy","indexBy"],function(t){o.prototype[t]=function(e,n){if(i.isString(e)){var r=l(e);e=function(t){return r(t)}}return i[t].call(i,this,e,n)}}),i.forEach(["toString","toLocaleString","join"],function(t){o.prototype[t]=r(t)}),o}(),_=function(){var t={enable:!0,type:"text",css:null},e={".":"-","(":"",")":"","[":"-","]":"-","'":"",'"':""},n=i.isUndefined,r="$identity",s="$auto",a=W.resultWith,u=W.fromPx,h=W.toPx,c=function(t,e,n){return i.isString(t)&&(t=e.$get(t)),i.isFunction(t)||(t=e.$get(n)),t},d=function(a){i.isString(a)&&(a={id:a});var u=a.escape,h=a.sortable;this.id=a.id,this.title=a.title||"",this.field=a.field||this.id,this.css=a.css||"",this.escape=n(u)?!0:!!u,this.width=a.width,this.sortable=n(h)?!0:!!h,this.draggable=!!a.draggable,this.asc=null;var d=a.editable===!0?{}:a.editable;if(d&&(d=i.defaults(d,t)),this.editable=d,!this.css)for(var f=0,v=this.id.length;v>f;++f){var p=this.id.charAt(f),g=e[p];this.css+=null!=g?g:p}u&&(this.title=o(this.title));var b=a.renderer||r,$=i.isArray(b)?b:[b];this.$renderer=i.map($,function(t){return c(t,H,r)}),this.$comparator=c(a.comparator,V,s),this.$parser=l(this.field)};return d.prototype={cssClasses:function(t,e,n){var r=n?[n]:[],s=a(this.css,this,r);i.isArray(s)&&(s=s.join(" "));var o=[s];this.sortable&&o.push(v),this.draggable&&o.push(b);var u=this.asc;return null!=u&&o.push(u?p:g),o.join(" ")},attributes:function(t,e){var n={};if(n[N]=this.id,e){if(this.sortable){n[S]=!0;var i=this.asc;null!=i&&(n[A]=i?F:T)}this.draggable&&(n.draggable=!0)}return n},styles:function(){var t={},e=h(this.computedWidth);return e&&(t.width=e,t.maxWidth=e,t.minWidth=e),t},updateWidth:function(t){return this.width=u(t),this},isEditable:function(t){return this.editable&&this.editable.enable?t?a(this.editable.enable,this,[t]):!0:!1},render:function(t){var e=this.field,n=this.value(t),r=i.reduce(this.$renderer,function(n,i){return i.call(H,n,t,e)},n);return null==r?"":this.escape?o(r):r},value:function(t,e){var n=this.$parser;return 2===arguments.length?(n.assign(t,e),this):null==t?"":n(t)}},d}(),K=function(){var t=function(t,n,i,r){var s=t.length-1;if(0>s||0>n||i>=n)return i;for(var o=Math.min(n,s),a=n;o>=0&&a>=n;){if(a=e.getDataIndex(t[o]),r(a,n))return o;o--}return i},e={getDataIndex:function(t){return Number(t.getAttribute(D))},getRowIndexForDataIndex:function(e,n){return t(e,n,-1,function(t,e){return t===e})},getPreviousRowIndexForDataIndex:function(e,n){return t(e,n-1,-1,function(t,e){return e>=t})},getCheckbox:function(t){return t.childNodes[0].childNodes[0]}};return e}(),G=function(){var t="THEAD",e="TFOOT",n="TBODY",r="TH",o="TR",a="INPUT",u="SELECT",h=function(t){return t.tagName===a&&"checkbox"===t.getAttribute("type")},c=function(t){var e=t.tagName,n=e===a||e===u;return n&&null!=t.getAttribute(N)},l=function(t){return!!t.getAttribute("draggable")},d=function(t,e){var n=I.findParent(t,e.tagName);return n===e},f={number:function(t){return Number(t)},checkbox:function(t){return!!t}},v={checkbox:"checked"},p=function(t,e){var n=t.target,s=I.findParent(t.target,r);if(n.tagName!==e)if(this.isSelectable()&&h(n))n.checked?this.select():this.deselect();else if(s&&s.getAttribute(S)){var o,a=s.getAttribute(N),u=s.getAttribute(A)||T,c=u===F?T:F,l=c+a;if(t.shiftKey){var d=u+a;o=i.reject(this.$comparators,function(t){return t.predicate()===d})}else o=[];o.push(l),this.sortBy(o)}},g={onClickThead:function(e){return p.call(this,e,t)},onClickTfoot:function(t){return p.call(this,t,e)},onClickTbody:function(t){if(this.isSelectable()){var e=t.target;if(e.tagName!==n&&!c(e)){var i=I.findParent(e,o),r=i.getAttribute(D),s=this.$data,a=s.at(r);if(this.isSelectable(a)){var u=this.$selection;if(this.options.selection.multi)if(t.shiftKey){for(var h=parseFloat(r),l=parseFloat(this.$$selectAnchor),d=Math.min(h,l),f=Math.max(h,l),v=[],p=d;f>=p;++p){var g=s.at(p);!u.contains(g)&&this.isSelectable(g)&&v.push(g)}v.length>0&&u.push.apply(u,v)}else u.toggle(a),this.$$selectAnchor=r;else{var b=u.indexOf(a);b>=0?u.remove(b,1):u.reset([a])}}}}},onInputTbody:function(t){var e=t.target,n=e.getAttribute(N),r=n?this.$columns.byKey(n):null;if(r&&r.isEditable()){var s=I.findParent(e,"TR");if(s){var o=r.editable.type,a=f[o]||i.identity,u=v[o]||"value",h=Number(s.getAttribute(D)),c=this.$data,l=c.at(h),d=r.value(l),p=a(e[u]);d!==p&&(r.value(l,p),this.dispatchEvent("datachanged",{index:h,object:l,field:n,oldValue:d,newValue:p}),c.replace(l))}}},onDragStart:function(t){var e=t.target,n=t.originalEvent||t,i=n.dataTransfer;l(e)&&(s(e).addClass($),i.effectAllowed="move",i.clearData(),i.setData("Text",e.getAttribute(N)))},onDragEnd:function(t){var e=t.target,n=this.$table[0];s(I.byTagName("th",n)).removeClass(m),l(e)&&d(e,n)&&s(t.target).removeClass($)},onDragOver:function(t){var e=t.target;if(l(e)&&d(e,this.$table[0])){var n=t.originalEvent||t,i=n.dataTransfer;return i.dropEffect="move",t.preventDefault(),!1}},onDragEnter:function(t){var e=t.target;return l(e)&&d(e,this.$table[0])?(s(e).addClass(m),t.preventDefault(),!1):void 0},onDragLeave:function(t){var e=t.target;return l(e)&&d(e,this.$table[0])?(s(e).removeClass(m),t.preventDefault(),!1):void 0},onDragDrop:function(t){var e=t.target;if(l(e)&&d(e,this.$table[0])){var n=t.originalEvent||t,i=n.dataTransfer,r=i.getData("Text"),o=e.getAttribute(N);if(r!==o){var a=this.$columns,u=a.indexOf(r),h=a.indexOf(o);a.add(a.remove(u,1),h),s(e).removeClass(m)}return t.preventDefault(),!1}},onSelectStart:function(t){var e=t.target;return l(e)?(t.preventDefault(),e.dragDrop(),!1):void 0}};return g}(),Y=function(){var e=function(t,e,n,r){var s=t["$"+e];s&&!t.$$events[r]&&(t.$$events[r]=i.bind(G[r],t),s.on(n,t.$$events[r]))},n=function(t,e,n,i){var r=t["$"+e];r&&t.$$events[i]&&(r.off(n,t.$$events[i]),t.$$events[i]=null)},r=function(){var t=h.hasEvent("input")?"input":"keyup";return t+=" change"},o="click",a=function(t,i,r){t["bind"+i]=function(t){r(t,e)},t["unbind"+i]=function(t){r(t,n)}},u={bindResize:function(e){if(!e.$$events.onResize){var n=i.bind(e.resize,e);e.$$events.onResize=i.debounce(n,100),e.$window=s(t),e.$window.on("resize",e.$$events.onResize)}},unbindResize:function(t){t.$$events.onResize&&(t.$window.off("resize",t.$$events.onResize),t.$window=null)}};return a(u,"Edition",function(t,e){e(t,z,r(),"onInputTbody")}),a(u,"Selection",function(t,e){e(t,O,o,"onClickThead"),e(t,R,o,"onClickTfoot"),e(t,z,o,"onClickTbody")}),a(u,"Sort",function(t,e){e(t,O,o,"onClickThead"),e(t,R,o,"onClickTfoot")}),a(u,"DragDrop",function(t,e){e(t,B,"dragstart","onDragStart"),e(t,B,"dragover","onDragOver"),e(t,B,"dragend","onDragEnd"),e(t,B,"dragleave","onDragLeave"),e(t,B,"dragenter","onDragEnter"),e(t,B,"drop","onDragDrop"),W.msie()<=9&&e(t,B,"selectstart","onSelectStart")}),u}(),Q=function(){var t="px",e="percent",n="auto",r={};r[t]=function(t){return W.fromPx(t.computedWidth)},r[e]=function(t,e){return W.fromPercentage(t.computedWidth)*e/100},r[n]=function(t,e,n){return e/n};var s={checkbox:function(t){return!!t}},o=function(t,e){var n=t.$selection.size(),i=I.span({title:n},""+n),r=t.isSelected(),s=I.inputCheckbox({checked:r,indeterminate:!r&&n>0}),o=e?[i,s]:[s,i],a={className:w};return I.th(a,o)},a={computeWidth:function(s,o){var a=s,u=0,h=o.groupBy(function(r){var s=r.computedWidth=i.result(r,"width");return i.isNumber(s)||W.isPx(s)?t:W.isPercentage(s)?e:n});i.forEach([t,e,n],function(t){var e=h[t];if(e){var n=a,s=e.length;i.forEach(e,function(e){var i=r[t](e,n,s);e.computedWidth=i,a-=i,u++})}})},theadRow:function(t){var e=[];return t.hasCheckbox()&&e.push(a.theadCheckboxCell(t)),t.$columns.forEach(function(n,i){e.push(a.theadCell(t,n,i))}),I.tr(null,e)},theadCell:function(t,e,n){var i=e.attributes(n,!0);return i.className=e.cssClasses(n,!0),i.style=e.styles(n,!0),I.th(i,e.title)},theadCheckboxCell:function(t){return o(t,!0)},tfootRow:function(t){var e=[];return t.hasCheckbox()&&e.push(a.tfootCheckboxCell(t)),t.$columns.forEach(function(n,i){e.push(a.tfootCell(t,n,i))}),I.tr(null,e)},tfootCell:function(t,e,n){return a.theadCell(t,e,n)},tfootCheckboxCell:function(t){return o(t,!1)},tbodyRows:function(t,e,n){for(var i=I.createFragment(),r=0,s=e.length;s>r;++r)i.appendChild(a.tbodyRow(t,e[r],n+r));return i},tbodyRow:function(t,e,n){var r={};r[D]=n,r[N]=t.$data.$$key(e),r[E]=i.uniqueId();var s=[],o="";return t.isSelectable()&&(t.isSelectable(e)&&(o+=x),t.$selection.contains(e)&&(o+=" "+C),t.hasCheckbox()&&s.push(a.tbodyCheckboxCell(t,e))),o&&(r.className=o),t.$columns.forEach(function(n,i){s.push(a.tbodyCell(t,e,n,i))}),I.tr(r,s)},tbodyCell:function(t,e,n,i){var r=n.attributes(i,!1);r.className=n.cssClasses(i,!1,e),r.style=n.styles(i,!1);var s=n.isEditable(e)?a.tbodyControl(n,e):n.render(e);return I.td(r,s)},tbodyCheckboxCell:function(t,e){var n={className:w},i=t.isSelectable(e)?I.inputCheckbox({checked:t.isSelected(e)}):null;return I.td(n,i)},tbodyControl:function(t,e){var n,r=t.editable,o=null,a={};"select"===r.type?(n="select",r.options&&(o=i.map(r.options,function(t){var e=null!=t.value?{value:t.value}:null,n=null!=t.label?t.label:"";return I.option(e,n)}))):(n="input",a.type=r.type),a[N]=t.id;var u="checkbox"===r.type?"checked":"value",h=s[r.type]||i.identity;return a[u]=h(t.value(e)),r.css&&(a.className=r.css),I[n](a,o)}};return a}(),X=function(){var t="px",e="percent",n="auto",r={};r[t]=function(t){return W.fromPx(t)},r[e]=function(t,e){return W.fromPercentage(t)*e/100},r[n]=function(t,e,n){return e/n};var s={resize:function(t){s.applySize(t)},applySize:function(t){var e=t.options.size,r=i.result(e,"width"),o=i.result(e,"height"),a=r&&r!==n,u=o&&o!==n;if(a){var h=W.toPx(r);t.$table.css({width:h,maxWidth:h,minWidth:h})}if(u){var c=W.toPx(o);t.$tbody.css({maxHeight:c})}var l=a?W.fromPx(r):null;l||(l=t.$table[0].offsetWidth),l-=I.scrollbarWidth(),t.hasCheckbox()&&(l-=30);var d=t.$columns,f=s.computeWidth(l,d);if(f.length>0)for(var v=i.indexBy(d.pendingChanges(),function(t){return t.type+"_"+t.index}),p=0,g=f.length;g>p;++p){var b=d.indexOf(f[p]);i.has(v,"update_"+b)||d.notifyUpdate(b)}return this},computeWidth:function(s,o){var a=s,h=0,c=new u,l=o.groupBy(function(r){var s=i.result(r,"width");return c.put(r.id,s),i.isNumber(s)||W.isPx(s)?t:W.isPercentage(s)?e:n}),d=[];return i.forEach([t,e,n],function(t){var e=l[t];if(e){var n=a,s=e.length;i.forEach(e,function(e){var i=r[t](c.get(e.id),n,s);i!==e.computedWidth&&(e.computedWidth=i,d.push(e)),a-=i,h++})}}),d}};return s}(),Z=function(){var t=K.getDataIndex,e=K.getPreviousRowIndexForDataIndex,n=K.getRowIndexForDataIndex,r={on:function(t){return i.forEach(t,function(t){var e="on"+W.capitalize(t.type);r[e].call(this,t)},this),this},onSplice:function(n){var r,o,a=this.$tbody,u=a[0],h=u.childNodes,c=n.index,l=n.addedCount,d=n.object,f=n.added,v=n.removed,p=e(h,c)+1,g=v.length;if(g>0){var b=0===c&&d.length-l===0;if(b)r=i.toArray(h),a.empty();else{r=[];for(var $=h[p],m=0;g>m&&$;++m){var y=c+m,x=t($);x===y&&(r.push(u.removeChild($)),$=h[p])}}var C=this.$selection;C&&C.length>0&&C.remove(v)}if(l>0){o=[];for(var w=I.createFragment(),k=this.$filter||i.constant(!0),E=0;l>E;++E){var N=E+c,S=f[E],A=d.ctx(S);if(A.visible=k(S),A.visible){var F=Q.tbodyRow(this,S,N);o.push(F),w.appendChild(F)}}o.length>0&&(p>0?s(h[p-1]).after(w):a.prepend(w))}if(r||o){for(var T=l-g,z=c+i.size(o),O=h.length;O>z;++z){var R=h[z],B=t(R);R.setAttribute(D,B+T)}this.dispatchEvent("dataspliced",{added:f||[],addedNodes:o||[],removedNodes:r||[],removed:v,index:c,nodeIndex:p})}return this},onUpdate:function(t){var e=t.index,i=this.$data.at(e),r=this.$tbody[0],s=r.childNodes,o=n(s,e);if(o>=0){var a=s[o],u=Q.tbodyRow(this,i,e),h=a.getAttribute(E);P.mergeNodes(r,a,u),a.setAttribute(E,h),this.dispatchEvent("dataupdated",{index:e,nodeIndex:o,node:a})}return this}};return r}(),tt=function(){var t=function(t){return t.getAttribute(N)},e=function(e,n){for(var r=[],s=e.childNodes,o=0,a=s.length;a>o;++o)for(var u=s[o],h=i.indexBy(u.childNodes,t),c=0,l=n.length;l>c;++c){var d=h[n[c].id];d&&r.push(u.removeChild(d))}return r},n=function(t,e,n){return t.insertBefore(e,t.childNodes[n]||null)},r={tbody:function(t,e,n){return Q.tbodyCell(this,this.$data.at(n),t,e)},thead:function(t,e){return Q.theadCell(this,t,e)},tfoot:function(t,e){return Q.tfootCell(this,t,e)}},s=function(t,e,n){return function(i,s){var o=i.childNodes[n],a=r[t].call(this,e,n,s),u=P.mergeNodes(i,o,a);return{oldNode:o,newNode:u}}},o=function(t,e){e.draggable=!!e.draggable||!!t.isDraggable(),t.isSortable()||(e.sortable=!1)},a={on:function(t){return i.forEach(t,function(t){var e="on"+W.capitalize(t.type);a[e].call(this,t)},this),this},onSplice:function(r){var s,a,u,h,c,l=this.$tbody[0],d=this.hasHeader()?this.$thead[0]:null,f=this.hasFooter()?this.$tfoot[0]:null,v=this.hasCheckbox(),p=r.index,g=r.added,b=r.addedCount,$=r.removed,m=[],y=[],x=[],C=this.$data,w=this.$columns,k=$.length,E=k>0||b>0;E&&this.isResizable()&&this.resize(),k>0&&(y.push.apply(y,e(l,$)),d&&m.push.apply(m,e(d,$)),f&&x.push.apply(x,e(f,$)));var S=[],A=[],D=[];if(b>0){for(s=0;b>s;++s){u=p+s;var F=g[s];if(o(this,F),d){var T=Q.theadCell(this,F,u);h=d.childNodes[0],S.push(n(h,T,v?u+1:u))}if(f){var z=Q.tfootCell(this,F,u);h=f.childNodes[0],D.push(n(h,z,v?u+1:u))}}for(a=0,c=l.childNodes.length;c>a;++a){h=l.childNodes[a];var O=i.indexBy(h.childNodes,t),R=h.getAttribute(N),B=C.byKey(R);for(s=0;b>s;++s){u=p+s;var W=g[s],I=W.id;O[I]&&h.removeChild(O[I]);var P=Q.tbodyCell(this,B,w.at(u),u);A.push(n(h,P,v?u+1:u))}}}if(E){var j=this.isEditable();b>0&&j?Y.bindEdition(this):k>0&&!j&&Y.unbindEdition(this),this.dispatchEvent("columnsspliced",{index:p,removedNodes:{thead:m,tbody:y,tfoot:x},addedNodes:{thead:S,tbody:A,tfoot:D}})}return this},onUpdate:function(t){var e=t.index,n=this.hasCheckbox()?e+1:e,r=this.$columns.at(e);o(this,r);var a=function(t){var e=[[],[]],o=this["$"+t];if(o){var a=o[0].childNodes,u=s.call(this,t,r,n),h=function(t,e,n){var i=u.call(this,e,n);return t[0].push(i.oldNode),t[1].push(i.newNode),t};e=i.reduce(a,h,e,this)}return e},u=i.map([O,R,z],a,this);return r.editable?Y.bindEdition(this):this.isEditable()||Y.unbindEdition(this),this.dispatchEvent("columnsupdated",{index:e,oldNodes:{thead:u[0][0],tfoot:u[1][0],tbody:u[2][0]},newNodes:{thead:u[0][1],tfoot:u[1][1],tbody:u[2][1]}}),this}};return a}(),et=function(){var t=K.getRowIndexForDataIndex,e=K.getCheckbox,n=function(t,e){t.checked=e},r={on:function(t){return i.forEach(t,function(t){var e="on"+W.capitalize(t.type),n=r[e];n&&n.call(this,t)},this),this},onSplice:function(i){var r,o,a,u,h=this.$tbody,c=this.$data,l=i.object,d=h[0],f=d.childNodes,v=i.added,p=i.removed,g=i.addedCount,b=p.length;if(b>0)for(var $=0;b>$;++$)r=c.indexOf(p[$]),r>=0&&(a=t(f,r),o=f[a],o&&(s(o).removeClass(C),this.hasCheckbox()&&(u=e(o),u&&n(u,!1))));if(g>0)for(var m=0;g>m;++m)r=c.indexOf(v[m]),a=t(f,r),o=f[a],o&&(s(o).addClass(C),this.hasCheckbox()&&(u=e(o),u&&n(u,!0)));if(g>0||b>0){var y=g-b;if(y&&this.hasCheckbox()){var x=l.length,w=this.isSelected(),k=x>0&&c.length!==x,E=this.hasHeader()?this.$thead[0]:null,N=this.hasFooter()?this.$tfoot[0]:null;if(E){var S=E.childNodes[0].childNodes[0],A=S.childNodes[0],D=S.childNodes[1];A.innerHTML=A.title=x,D.checked=w,D.indeterminate=k}if(N){var F=N.childNodes[0].childNodes[0],T=F.childNodes[1],z=F.childNodes[0];T.innerHTML=T.title=x,z.checked=w,z.indeterminate=k}}this.dispatchEvent("selectionchanged",function(){return{selection:this.$selection.toArray()}})}return this}};return r}(),nt=function(){var t={applyFilter:function(t){var e=null==t?i.constant(!0):t,n=function(t,n,r){var s=this.$tbody[0],o=s.childNodes,a=this.$data.ctx(n),u=i.isUndefined(a.visible)?!0:!!a.visible,h=!!e(n),c=0,l=null;if(a.visible=h,u!==h){var d=o[a.idx-t.nbFiltered];if(h){var f=Q.tbodyRow(this,n,r);s.insertBefore(f,d)}else l=s.removeChild(d),c++}else h||c++;return t.nbFiltered+=c,l&&t.removed.push(l),t},r={nbFiltered:0,removed:[]},s=this.$data.reduce(n,r,this),o=s.nbFiltered,a=s.removed;this.dispatchEvent("filterupdated",{predicate:t,countVisible:this.$data.size()-o,countFiltered:o,removedNodes:a})}};return t}(),it=function(){var t=function(t){return function(){throw"Function "+t+" must be implemented"}},e=function(){};return e.prototype={compare:t("compare"),equals:function(t){return this.predicate()===t.predicate()},predicate:function(){return this.id;
}},e}(),rt=function(){var t=function(t,e){var n=e.charAt(0),i=n===F||n===T?e.slice(1):e,r=t.$columns.byKey(i);this.id=i,this.asc=n!==T;var s,o;r&&(s=r.$parser,o=r.$comparator),this.parser=s||l(i),this.comparator=o||V.$auto},e=t.prototype=new it;return e.compare=function(t,e){if(t===e)return 0;var n=this.parser(t),i=this.parser(e),r=this.comparator(n,i);return this.asc?r:-1*r},e.predicate=function(){var t=this.asc?F:T;return t+this.id},e.equals=function(t){return this.id===t.id&&this.asc===t.asc&&this.comparator===t.comparator},t.of=function(e,n){return n instanceof t?n:new t(e,n)},t}(),st=function(){var t=function(t,e){this.id=i.uniqueId(),this.comparator=e},e=t.prototype=new it;return e.compare=function(t,e){return t===e?0:this.comparator(t,e)},t.of=function(e,n){return n instanceof t?n:new t(e,n)},t}(),ot=function(){var t=function(t,e){this.id=i.uniqueId(),this.parser=e},e=t.prototype=new it;return e.compare=function(t,e){if(t===e)return 0;var n=this.parser(t),i=this.parser(e);return V.$auto(n,i)},t.of=function(e,n){return n instanceof t?n:new t(e,n)},t}(),at=function(){var t=function(t,e){if(t===e||null==t&&null==e)return 0;for(var n=this.$comparators,i=0,r=n.length;r>i;++i){var s=n[i],o=s.compare(t,e);if(o)return o}var a=this.$data;return a.indexOf(t)-a.indexOf(e)},e=function(t,e){if(e instanceof it)return e;if(i.isString(e))return rt.of(t,e);if(i.isFunction(e)){var n=e.length;return 1>=n?ot.of(t,e):st.of(t,e)}throw"Cannot create comparator from object: "+e};return{of:function(t,n){return i.isArray(n)||(n=[n]),i.map(n,function(n){var i=e(t,n),r=t.$columns.byKey(i.id);return r&&(r.asc=i.asc),i})},equals:function(t,e){return t===e?!0:t.length!==e.length?!1:i.every(t,function(t,n){return t.equals(e[n])})},createComparator:function(e){return i.bind(t,e)}}}(),ut=function(){var t=W.resultWith,e=function(t){var e="$"+t,n=this.$table;this[e]=s(I.byTagName(t,n[0])),this[e].length||(this[e]=s(I[t]())),n.append(this[e][0])},r=function(t){var e=this.options.events[t];e&&this.addEventListener(t.slice(2),this.options.events[t])},o=function(t,e){if(!(this instanceof o))return new o(t,e);0!==arguments.length&&(i.isElement(t)||t instanceof s)||(e=t,t=null);var n=t?s(t)[0]:null,a=this.options=e=e||{},u=o.options;i.forEach(i.keys(u),function(t){var e=a[t],r=u[t];if(i.isUndefined(e)&&n){var s=W.toSpinalCase(t),o=n.getAttribute("data-waffle-"+s)||n.getAttribute("waffle-"+s)||n.getAttribute("data-"+s)||n.getAttribute(s);o&&(e=a[t]=W.parse(o))}i.isObject(r)&&(i.isObject(e)||i.isUndefined(e))&&(e=a[t]=i.defaults(e||{},r)),i.isUndefined(e)&&(e=a[t]=r)}),a.size={width:a.size.width,height:a.size.height},a.scrollable=a.scrollable||!!a.size.height;var h=this.isSortable(),c=this.isDraggable();!a.columns||h&&!c||i.forEach(a.columns,function(t){h||(t.sortable=!1),c&&(t.draggable=null==t.draggable?!0:!!t.draggable)}),this.$data=new J(a.data,{key:a.key,model:a.model}),this.$columns=new J(a.columns,{key:"id",model:_}),this.$selection=new J([],this.$data.options()),this.$comparators=new J([],{key:function(t){return t.id}}),this.$bus=new L,i.forEach(i.keys(a.events),r,this),this.sortBy(e.sortBy,!1),n&&this.attach(n),this.dispatchEvent("initialized")};o.create=function(t,e){return new o(t,e)},o.prototype={attach:function(t){this.$table&&this.detach();var n=this.$table=s(t),r=this.isSortable(),o=this.isDraggable(),a=this.isSelectable(),u=this.isEditable();n.addClass(this.cssClasses().join(" "));var h=[z];return this.hasHeader()&&h.unshift(O),this.hasFooter()&&h.push(R),i.forEach(h,e,this),this.$data.observe(Z.on,this),this.$columns.observe(tt.on,this),this.$selection.observe(et.on,this),this.$$events={},r&&Y.bindSort(this),u&&Y.bindEdition(this),a&&Y.bindSelection(this),this.isResizable()&&(this.resize(),Y.bindResize(this)),this.render(),this.clearChanges(),o&&Y.bindDragDrop(this),this.dispatchEvent("attached"),this},detach:function(){var t=this.$table;return t&&(t.removeClass(this.cssClasses().join(" ")),Y.unbindSort(this),Y.unbindEdition(this),Y.unbindSelection(this),Y.unbindResize(this),Y.unbindDragDrop(this),this.clearChanges(),this.$data.unobserve(Z.on,this),this.$columns.unobserve(tt.on,this),this.$selection.unobserve(et.on,this),this.dispatchEvent("detached"),this.$table=this.$tbody=this.$thead=this.$tfoot=null),this},cssClasses:function(){var t=[f];return this.isSelectable()&&t.push(x),this.isScrollable()&&t.push(y),t},rows:function(){return i.toArray(this.$tbody[0].childNodes)},data:function(){return this.$data},columns:function(){return this.$columns},selection:function(){return this.$selection},isEditable:function(){return this.options.editable||this.$columns.some(function(t){return t.isEditable()})},isSortable:function(){return this.options.sortable},isSelectable:function(e){var n=this.options.selection;return n&&n.enable?e?t(n.enable,this,[e]):!0:!1},isResizable:function(){var t=this.options.size;return!!t.height||!!t.width},isScrollable:function(){return this.options.scrollable},hasCheckbox:function(){return this.isSelectable()&&this.options.selection.checkbox},hasHeader:function(){return this.options.view.thead},hasFooter:function(){return this.options.view.tfoot},isSelected:function(t){if(!this.isSelectable())return!1;if(t)return this.$selection.contains(t);var e=this.$selection.length;if(0===e)return!1;var n=this.$data.length;return i.isFunction(this.options.selection.enable)&&(n=this.$data.filter(this.isSelectable,this).length),e>=n},isDraggable:function(){return!!this.options.dnd},isVisible:function(t){var e=this.$data.ctx(t);return e&&e.visible!==!1},visibleData:function(){var t=this.$data,e=this.$filter;return null!=e?t.filter(this.isVisible,this):t.toArray()},render:function(t){return this.renderHeader().renderFooter().renderBody(t).clearChanges()},renderHeader:function(){if(this.hasHeader()){var t=Q.theadRow(this);this.$thead.empty().append(t)}return this},renderFooter:function(){if(this.hasFooter()){var t=Q.tfootRow(this);this.$tfoot.empty().append(t)}return this},renderBody:function(t){var e=null==t?this.options.async:t,n=this,r=this.rows(),s=i.once(function(){n.$tbody.empty()}),o=function(t,e){var i=Q.tbodyRows(n,t,e);s(),n.$tbody.append(i)},a=function(){n.$data.clearChanges(),n.dispatchEvent("rendered",{data:n.data(),removedNodes:r,addedNodes:n.rows()}),n=s=o=a=r=null},u=null==this.$filter?this.$data:this.visibleData();return e?W.asyncTask(W.split(u,200),10,o,a):(o(u,0),a()),this},resize:function(){return X.resize(this),this},select:function(){return this.$selection.length!==this.$data.length&&this.$selection.add(this.$data.filter(this.isSelectable,this)),this},deselect:function(){return this.$selection.isEmpty()||this.$selection.clear(),this},sortBy:function(t,e){var n=null!=t?at.of(this,t):[];if(at.equals(this.$comparators,n))return this;if(this.$comparators.reset(n),this.$data.sort(at.createComparator(this)),this.$table){var r=this.hasHeader(),s=this.hasFooter(),o=r?this.$thead.children().eq(0).children():null,a=s?this.$tfoot.children().eq(0).children():null,u=function(t){t.removeClass(p+" "+g).removeAttr(A)},h=function(t,e,n){var i=n?F:T;t.eq(e).addClass(n?p:g).attr(A,i)};o&&u(o),a&&u(a);var c=this.$columns,l=this.hasCheckbox();i.forEach(this.$comparators,function(t){var e=t.id,n=t.asc,i=c.indexOf(e),r=l?i+1:i;i>=0&&(o&&h(o,r,n),a&&h(a,r,n))})}return e!==!1&&this.renderBody(),this.dispatchEvent("sorted")},filter:function(t){var e=null==t||""===t,i=e?n:t,r=this.$filter,s=r?r.$predicate:null,o=null==s||s!==i;return o&&(this.$filter=null==i?n:q.$create(i),nt.applyFilter.call(this,this.$filter)),this},removeFilter:function(){return null!=this.$filter&&this.filter(n),this},dispatchEvent:function(t,e){return this.$bus.dispatchEvent(this,t,e),this.$bus.dispatchEvent(this,"updated"),this},addEventListener:function(t,e){return this.$bus.addEventListener(t,e),this},removeEventListener:function(t,e){return this.$bus.removeEventListener(t,e),this},clearChanges:function(){return this.$data.clearChanges(),this.$columns.clearChanges(),this.$selection&&this.$selection.clearChanges(),this},destroy:function(){this.detach(),this.$bus.clear(),this.$$events=null,W.destroy(this)}},o.options={key:"id",data:null,columns:null,sortBy:null,async:!1,scrollable:!1,sortable:!0,editable:!1,dnd:!1,selection:{enable:!0,checkbox:!0,multi:!1},view:{thead:!0,tfoot:!1},size:{width:null,height:null},events:{}};var a=["onInitialized","onUpdated","onRendered","onDataSpliced","onDataChanged","onDataUpdated","onColumnsSpliced","onColumnsUpdated","onSelectionChanged","onFilterUpdated","onSorted","onAttached","onDetached"];return i.forEach(a,function(t){o.options.events[t]=null}),o}(),ht={Grid:ut,options:ut.options,create:ut.create,addRenderer:function(t,e){return H[t]=e,ht},addComparator:function(t,e){return V[t]=e,ht}};return r.WaffleView=function(){var t="_cid",e=function(t){return function(){var e=i.last(arguments);return e.waffle||this[t].apply(this,arguments),this}},n={},s=["add","remove","reset","change","sort"],o=["datachanged","sorted"];i.forEach(s,function(t){n[t]=e("on"+W.capitalize(t))});var a=function(t){this.listenTo(this.collection,t,n[t])},u=function(t){var e="_"+t,n=this[e];this.grid.addEventListener(t,i.bind(n,this))},h=function(e){i.extend(this,e.toJSON()),this[t]=e.cid},c=function(t){var e=function(e,n){var i=e instanceof r.Model?e.toJSON():e,s=n instanceof r.Model?n.toJSON():n;return t(i,s)};return e.$$sortFn=t,e},l=r.View.extend({tagName:"table",constructor:function(t){r.View.apply(this,arguments),this.initializeWaffle(t),this.setupListener()},initializeWaffle:function(e){if(!this.grid){var n=e||{},r=i.extend(n.waffle||{},{data:this.collection.models,sortBy:this.collection.comparator,model:h,key:t});this.grid=ht.create(this.el,r)}return this.grid.$comparators.length>0&&this._sorted(),this},remove:function(){var t=r.View.prototype.remove.apply(this,arguments);return this.grid.destroy(),t},setElement:function(){var t=r.View.prototype.setElement.apply(this,arguments);return this.grid&&this.grid.attach(this.el),t},setupListener:function(){return i.forEach(s,a,this),i.forEach(o,u,this),this},onAdd:function(t,e,n){return this.grid.data().add(t,n.index),this},onRemove:function(t){return this.grid.data().remove(t),this},onReset:function(t){return this.grid.data().reset(t.models),this},onChange:function(t){return this.grid.data().replace(t),this},onSort:function(t){var e=t.comparator,n=i.isFunction(e)&&i.isFunction(e.$$sortFn)?e.$$sortFn:e;return n!==this.grid.$data.$$sortFn&&this.grid.sortBy(n),this},_datachanged:function(e){var n=e.details,i=n.object[t],r=this.collection.get(i);return r.set(n.field,n.newValue,{waffle:!0}),this},_sorted:function(){return this.collection.comparator=c(this.grid.$data.$$sortFn),this.collection.sort({waffle:!0}),this}}),d=["filter","removeFilter","select","deselect","resize","render","renderBody","renderFooter","renderHeader"];return i.forEach(d,function(t){l.prototype[t]=function(){var e=this.grid[t].apply(this.grid,arguments);return e===this.grid?this:e}}),l}(),r.Waffle=ht,r})}(window,document,void 0);